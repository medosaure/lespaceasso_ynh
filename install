#!/bin/bash
# Script d'installation YunoHost pour lespaceasso
set -e

# Variables
app=lespaceasso
install_dir=/var/www/$app

# Création du dossier
mkdir -p $install_dir

# Récupération du code source
git clone https://github.com/medosaure/lespaceasso.git $install_dir

# Installation des dépendances
cd $install_dir/src
npm install

# Build et lancement
npm run build || true
npm run start &

# Configuration nginx
yunohost app setting $app domain -v $YNH_APP_ARG_DOMAIN
yunohost app setting $app path -v $YNH_APP_ARG_PATH

# Génération du fichier de config nginx
nginx_conf="/etc/nginx/conf.d/$YNH_APP_ARG_DOMAIN.d/$app.conf"
cat > $nginx_conf <<EOL
location $YNH_APP_ARG_PATH/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
EOL

systemctl reload nginx

exit 0
